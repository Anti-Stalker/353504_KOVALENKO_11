{% extends 'base.html' %}
{% load static %}

{% block title %}Аналитика{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <h1 class="mb-4">Панель аналитики</h1>

    {% if error %}
    <div class="alert alert-danger" role="alert">
        {{ error }}
    </div>
    {% endif %}

    {% include 'analytics/filter_form.html' %}

    <div class="row">
        <!-- Текущая информация -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Текущая информация</h5>
                </div>
                <div class="card-body">
                    <p><strong>Дата:</strong> {{ current_date }}</p>
                    <p><strong>Время:</strong> {{ current_time }}</p>
                    <p><strong>Часовой пояс:</strong> {{ timezone }}</p>
                </div>
            </div>
        </div>

        <!-- Общая статистика -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Общая статистика</h5>
                </div>
                <div class="card-body">
                    {% if total_sales %}
                    <div class="row">
                        <div class="col-md-4">
                            <h6>Продажи</h6>
                            <p class="h3">{{ total_sales.total_amount|floatformat:2 }} ₽</p>
                        </div>
                        <div class="col-md-4">
                            <h6>Средний чек</h6>
                            <p class="h3">{{ total_sales.avg_sale|floatformat:2 }} ₽</p>
                        </div>
                        <div class="col-md-4">
                            <h6>Продано книг</h6>
                            <p class="h3">{{ total_sales.total_books }}</p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <h6>Медиана продаж</h6>
                            <p class="h3">{{ median_sale|floatformat:2 }} ₽</p>
                        </div>
                        <div class="col-md-4">
                            <h6>Мода продаж</h6>
                            <p class="h3">{{ mode_sale|floatformat:2 }} ₽</p>
                        </div>
                    </div>
                    {% else %}
                    <p class="text-muted">Нет данных о продажах</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- График продаж по дням -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Продажи по дням</h5>
                </div>
                <div class="card-body">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>
        </div>

        <!-- График по жанрам -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Продажи по жанрам</h5>
                </div>
                <div class="card-body">
                    <canvas id="genreChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Статистика по возрасту -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Возрастная статистика</h5>
                </div>
                <div class="card-body">
                    <canvas id="ageChart"></canvas>
                    {% if age_stats %}
                    <div class="mt-3">
                        <p><strong>Средний возраст:</strong> {{ age_stats.avg_age|floatformat:1 }}</p>
                        <p><strong>Медианный возраст:</strong> {{ median_age }}</p>
                        <p><strong>Всего клиентов:</strong> {{ age_stats.total_customers }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Календарь -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Календарь</h5>
                </div>
                <div class="card-body">
                    <pre class="mb-0">{{ calendar }}</pre>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Статистика пользователей</h5>
                </div>
                <div class="card-body">
                    {% if age_stats %}
                    <p>Средний возраст клиентов: {{ age_stats.avg_age|floatformat:0 }} лет</p>
                    <p>Медианный возраст клиентов: {{ median_age|floatformat:0 }} лет</p>
                    <p>Всего клиентов: {{ age_stats.total_customers }}</p>
                    {% endif %}
                    
                    {% if median_session_duration %}
                    <p>Медианное время на сайте: {{ median_session_duration }}</p>
                    {% endif %}
                    
                    {% if conversion_rate %}
                    <p>Конверсия (продажи/просмотры): {{ conversion_rate|floatformat:2 }}%</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Распределение посещений по часам</h5>
                </div>
                <div class="card-body">
                    <canvas id="visitsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Данные для графиков
    const salesData = {{ sales_by_date_json|safe }};
    const genreData = {{ sales_by_genre_json|safe }};
    const ageData = {{ age_groups_json|safe }};

    // График продаж по дням
    const salesChart = new Chart(document.getElementById('salesChart'), {
        type: 'line',
        data: {
            labels: salesData.map(item => item.date),
            datasets: [{
                label: 'Сумма продаж',
                data: salesData.map(item => item.total_sales),
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            }, {
                label: 'Количество книг',
                data: salesData.map(item => item.books_sold),
                borderColor: 'rgb(255, 99, 132)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Динамика продаж'
                }
            }
        }
    });

    // График по жанрам
    const genreChart = new Chart(document.getElementById('genreChart'), {
        type: 'pie',
        data: {
            labels: genreData.map(item => item.genre),
            datasets: [{
                data: genreData.map(item => item.total_sold),
                backgroundColor: [
                    'rgb(255, 99, 132)',
                    'rgb(54, 162, 235)',
                    'rgb(255, 205, 86)',
                    'rgb(75, 192, 192)',
                    'rgb(153, 102, 255)'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Распределение по жанрам'
                }
            }
        }
    });

    // График возрастных групп
    const ageChart = new Chart(document.getElementById('ageChart'), {
        type: 'bar',
        data: {
            labels: ageData.map(item => item.age),
            datasets: [{
                label: 'Количество клиентов',
                data: ageData.map(item => item.count),
                backgroundColor: 'rgb(75, 192, 192)'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Возрастные группы'
                }
            }
        }
    });

    // График посещений по часам
    const visitsChart = new Chart(document.getElementById('visitsChart'), {
        type: 'bar',
        data: {
            labels: {{ visits_by_hour|safe }}.map(item => `${item.hour}:00`),
            datasets: [{
                label: 'Количество посещений',
                data: {{ visits_by_hour|safe }}.map(item => item.count),
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
});
</script>
{% endblock %} 